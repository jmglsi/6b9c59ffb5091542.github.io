---
title: 内网折腾之打洞组网
toc: true
date: 2023-10-11 17:53:39
categories: 内网
tags:
- ZeroTier
- Tailscale
---
家里是有公网 ip 的，写写没有的情况，应该会有需要。
<!-- more -->

> 你可以尝试跟运营商打电话说要装监控，有概率能要到。
> 要得到的话路由器 [DDNS](https://baike.baidu.com/item/ddns/670146) 端口转发也可以，但我感觉不太安全。
> 也可以用内网穿透服务 ([ngrok](https://ngrok.cc)、[花生壳](https://hsk.oray.com) 等等)，当然一般会有流量带宽限制。

[ZeroTier](https://www.zerotier.com) 和 [Tailscale](https://tailscale.com) 都可以打洞组网，后者的配置相对简单一些。

下面是 [软路由](https://cloud.tencent.com/developer/article/1850766) 上配置 `ZeroTier` 需要注意的地方。

# 第一步

我刷的 [OpenWrt](https://openwrt.org)，装好插件以后在这里。

![截屏2023-10-11_18.12.27.png](/images/截屏2023-10-11_18.12.27.png)

# 第二步

> 你想和他人组网的话，可以填其他人的，同样需要别人允许。

输入你在 `ZeroTier` 注册分配的 `Network ID`，然后保存并应用。

![截屏2023-10-11_18.13.52.png](/images/截屏2023-10-11_18.13.52.png)

勾选允许客户端 NAT。

# 第三步

`ZeroTier` 官网 `Network ID` 点进去，拉到底下【Auth】允许下你的路由器设备。

![截屏2023-10-11_18.23.27.png](/images/截屏2023-10-11_18.23.27.png)

然后往上滑滑。

![截屏2023-10-11_18.24.34.png](/images/截屏2023-10-11_18.24.34.png)

`Destination` 是你的内网段，比如我家就是 `192.168.24.x`，`Via` 填下面 `ZeroTier` 分配的虚拟内网 ip。当然，你也可以手动重新指定一个好记的 (`192.168.191.10` 就是我重新指定的)。然后 Submit 就好了。

# 第四步

> 软路由上还需要配置一下下。
> 你加入了几个 `Network ID` 就得搞几个接口，建议用前缀区分下。

【网络-接口】新建一个接口，不配置协议，选择 `zt` 开头的。

![截屏2023-10-11_18.32.14.png](/images/截屏2023-10-11_18.32.14.png)

【网络-防火墙-自定义规则】`ztid` 替换成接口分配的 `ztxxxxxxx`。

```
# 自己
iptables -I FORWARD -i ztid -j ACCEPT
iptables -I FORWARD -o ztid -j ACCEPT
iptables -t nat -I POSTROUTING -o ztid -j MASQUERADE

# 其他人
iptables -I FORWARD -i ztid -j ACCEPT
iptables -I FORWARD -o ztid -j ACCEPT
iptables -t nat -I POSTROUTING -o ztid -j MASQUERADE
```

【网络-防火墙】点进去把刚新建的接口钩上。

![截屏2023-10-11_18.35.40.png](/images/截屏2023-10-11_18.35.40.png)

保存并应用。

> 到这里已经是配置好了。

接下来用你的手机或者别的网里的设备装个 `ZeroTier` 客户端，授权完试一下原来的内网网段，应该是好了。